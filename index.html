<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Dragon Warrior</title>
<style>
  body {
    margin: 0; 
    background: #000;
    overflow: hidden;
    font-family: monospace;
    color: white;
    touch-action: none; /* prevent default touch scrolling */
  }
  #gameCanvas {
    background: #111;
    display: block;
    margin: auto;
    border: 2px solid #555;
    max-width: 100vw;
    height: auto;
  }
  #info {
    text-align: center;
    margin-top: 5px;
    font-weight: bold;
  }
  #startScreen, #gameOverScreen {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: monospace;
    z-index: 9999;
  }
  #startScreen h1 {
    font-size: 48px;
    margin-bottom: 20px;
  }
  #startScreen button, #gameOverScreen button {
    padding: 15px 30px;
    font-size: 20px;
    background: #228B22;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
  }
  #startScreen button:hover, #gameOverScreen button:hover {
    background: #1e6e1e;
  }
  #gameOverScreen {
    display: none;
  }

  /* Joystick container */
  #joystickContainer {
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    background: rgba(50,50,50,0.5);
    border-radius: 50%;
    touch-action: none;
    user-select: none;
    z-index: 10000;
  }
  #joystickBase {
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(200,200,200,0.2);
    border-radius: 50%;
  }
  #joystickThumb {
    position: absolute;
    width: 60px;
    height: 60px;
    background: rgba(100, 255, 100, 0.7);
    border-radius: 50%;
    top: 30px;
    left: 30px;
    touch-action: none;
  }

  /* Attack button */
  #attackButton {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 80px;
    height: 80px;
    background: #dc3545;
    border-radius: 50%;
    color: white;
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    line-height: 80px;
    user-select: none;
    z-index: 10000;
    box-shadow: 0 0 15px #dc3545;
    touch-action: none;
  }
  #attackButton:active {
    background: #b02a37;
    box-shadow: none;
  }
</style>
</head>
<body>

<div id="startScreen">
  <h1>Dragon Warrior</h1>
  <p>Defeat the dragon across 5 levels!</p>
  <button onclick="startGame()">Start Game</button>
</div> 

<canvas id="gameCanvas" width="800" height="600"></canvas>

<div id="info">Use arrow keys or joystick to move. Press A or attack button to shoot. Press W or climb walls (levels 4+).</div>

<div id="gameOverScreen">
  <h2>Game Over</h2>
  <button onclick="restartGame()">Restart Game</button>
</div>

<!-- Joystick UI -->
<div id="joystickContainer" style="display:none;">
  <div id="joystickBase"></div>
  <div id="joystickThumb"></div>
</div>

<!-- Attack Button -->
<div id="attackButton" style="display:none;">A</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const joystickContainer = document.getElementById('joystickContainer');
const joystickThumb = document.getElementById('joystickThumb');
const attackButton = document.getElementById('attackButton');

const castleColors = ['#8B7D7B', '#6B8E23', '#8B4513', '#2F4F4F', '#483D8B'];
const maxLevel = 5;
let currentLevel = 1;
let gameOver = false;

const keys = {};
document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

// --- Joystick variables ---
let joystickActive = false;
let joystickPos = { x: 0, y: 0 };
const joystickRadius = 50;
const joystickMaxDist = 40;
let moveX = 0;
let moveY = 0;

// Helper to get touch position relative to joystick container
function getTouchPos(touch) {
  const rect = joystickContainer.getBoundingClientRect();
  return {
    x: touch.clientX - rect.left,
    y: touch.clientY - rect.top
  };
}

// Joystick touch handlers
joystickContainer.addEventListener('touchstart', (e) => {
  e.preventDefault();
  joystickActive = true;
  const pos = getTouchPos(e.touches[0]);
  moveJoystick(pos.x, pos.y);
});
joystickContainer.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if(!joystickActive) return;
  const pos = getTouchPos(e.touches[0]);
  moveJoystick(pos.x, pos.y);
});
joystickContainer.addEventListener('touchend', (e) => {
  e.preventDefault();
  joystickActive = false;
  moveX = 0;
  moveY = 0;
  joystickThumb.style.transform = `translate(0px, 0px)`;
});

function moveJoystick(x, y) {
  let dx = x - joystickRadius;
  let dy = y - joystickRadius;

  // Limit distance to max radius
  const dist = Math.sqrt(dx*dx + dy*dy);
  if(dist > joystickMaxDist) {
    dx = dx / dist * joystickMaxDist;
    dy = dy / dist * joystickMaxDist;
  }
  joystickThumb.style.transform = `translate(${dx}px, ${dy}px)`;

  // Normalize to range -1 to 1
  moveX = dx / joystickMaxDist;
  moveY = dy / joystickMaxDist;
}

// Attack button touch handler
let attackPressed = false;
attackButton.addEventListener('touchstart', (e) => {
  e.preventDefault();
  attackPressed = true;
});
attackButton.addEventListener('touchend', (e) => {
  e.preventDefault();
  attackPressed = false;
});

// Adjust canvas size for mobile
function resizeCanvas() {
  const ratio = 4 / 3; // 800x600 aspect ratio
  let width = window.innerWidth;
  let height = window.innerHeight;

  if(width / height > ratio) {
    width = height * ratio;
  } else {
    height = width / ratio;
  }

  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// --- SPRITES and game logic as before ---

const colors = {
  'R': '#0033cc', // hero blue shirt
  'W': '#fffacd', // skin tone
  'G': '#228B22', // dragon green
  '.': null
};

const heroFrames = [
  [
    '.....RRR.....',
    '.....RRR.....',
    '....RWRWR....',
    '....RRRRR....',
    '...RWWWWWR...',
    '..RRR..RRR...',
    '.RWW....WWR..',
    'RRR......RRR.',
  ],
  [
    '.....RRR.....',
    '.....RRR.....',
    '....RWRWR....',
    '....RRRRR....',
    '...RWWWWWR...',
    '..RRR..RRR...',
    '.RWW....WWR..',
    'RRRR.....WRR.',
  ]
];

const dragonFrames = [
  [
    '...GGGGGGG...',
    '..GGGGGGGGG..',
    '.GGGGGGGGGGG.',
    'GGGGGGGGGGGGG',
    'GGGGG...GGGGG',
    'GGGGG...GGGGG',
    'GGGGGGGGGGGGG',
    '..GGGGGGGGG..',
  ],
  [
    '...GGGGGGG...',
    '..GGGGGGGGG..',
    '.GGGGGGGGGGG.',
    'GGGGGGGGGGGGG',
    'GGGGG...GGGGG',
    'GGGGG...GGGGG',
    'GGGGGGGGGGGGG',
    '..GGGGG.GGG..',
  ]
];

// Draw sprite function (same as original)
function drawSprite(x, y, scale, frameIndex, spriteData) {
  const frame = spriteData[frameIndex];
  for (let r = 0; r < frame.length; r++) {
    for (let c = 0; c < frame[r].length; c++) {
      const colorCode = frame[r][c];
      const color = colors[colorCode];
      if (color) {
        ctx.fillStyle = color;
        ctx.fillRect(x + c * scale, y + r * scale, scale, scale);
      }
    }
  }
}

// Hero and dragon positions and states
const hero = {
  x: 50,
  y: 480,
  width: 12*4,
  height: 8*4,
  speed: 3,
  frame: 0,
  frameCount: 0,
  onWall: false,
};

const dragon = {
  x: 650,
  y: 450,
  width: 13*4,
  height: 8*4,
  frame: 0,
  frameCount: 0,
  health: 10
};

const bullets = [];
const maxBullets = 5;

function shootBullet() {
  if(bullets.length < maxBullets) {
    bullets.push({
      x: hero.x + hero.width,
      y: hero.y + hero.height/2 - 4,
      width: 8,
      height: 4,
      speed: 7
    });
  }
}

// Game loop
function gameLoop() {
  if(gameOver) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw castle background
  ctx.fillStyle = castleColors[currentLevel - 1];
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Handle hero movement - keyboard or joystick
  let dx = 0, dy = 0;

  // Keyboard controls
  if(keys['arrowleft'] || keys['a']) dx = -hero.speed;
  if(keys['arrowright'] || keys['d']) dx = hero.speed;
  if(keys['arrowup'] || keys['w']) dy = -hero.speed;
  if(keys['arrowdown'] || keys['s']) dy = hero.speed;

  // Joystick controls override keyboard if active
  if(joystickActive) {
    dx = moveX * hero.speed;
    dy = moveY * hero.speed;
  }

  hero.x += dx;
  hero.y += dy;

  // Clamp hero position inside canvas
  hero.x = Math.max(0, Math.min(canvas.width - hero.width, hero.x));
  hero.y = Math.max(0, Math.min(canvas.height - hero.height, hero.y));

  // Animate hero
  hero.frameCount++;
  if(hero.frameCount > 10) {
    hero.frame = (hero.frame + 1) % heroFrames.length;
    hero.frameCount = 0;
  }

  // Draw hero
  drawSprite(hero.x, hero.y, 4, hero.frame, heroFrames);

  // Dragon animation
  dragon.frameCount++;
  if(dragon.frameCount > 15) {
    dragon.frame = (dragon.frame + 1) % dragonFrames.length;
    dragon.frameCount = 0;
  }

  // Draw dragon
  drawSprite(dragon.x, dragon.y, 4, dragon.frame, dragonFrames);

  // Update and draw bullets
  for(let i = bullets.length - 1; i >= 0; i--) {
    const b = bullets[i];
    b.x += b.speed;
    ctx.fillStyle = 'yellow';
    ctx.fillRect(b.x, b.y, b.width, b.height);

    // Bullet hits dragon
    if(b.x + b.width > dragon.x &&
       b.y + b.height > dragon.y &&
       b.y < dragon.y + dragon.height) {
      bullets.splice(i, 1);
      dragon.health--;
      if(dragon.health <= 0) {
        nextLevel();
      }
      continue;
    }

    // Remove bullets off screen
    if(b.x > canvas.width) {
      bullets.splice(i, 1);
    }
  }

  // Shoot bullet on attack key or attack button
  if((keys[' '] || keys['enter'] || keys['a'] || attackPressed)) {
    shootBullet();
  }

  requestAnimationFrame(gameLoop);
}

function nextLevel() {
  currentLevel++;
  if(currentLevel > maxLevel) {
    gameOver = true;
    showGameOver();
  } else {
    dragon.health = 10 + currentLevel * 5;
    hero.x = 50;
    hero.y = 480;
  }
}

function showGameOver() {
  document.getElementById('gameOverScreen').style.display = 'flex';
  joystickContainer.style.display = 'none';
  attackButton.style.display = 'none';
}

function startGame() {
  document.getElementById('startScreen').style.display = 'none';
  joystickContainer.style.display = 'block';
  attackButton.style.display = 'block';
  gameOver = false;
  currentLevel = 1;
  dragon.health = 10;
  hero.x = 50;
  hero.y = 480;
  keys['a'] = false;
  attackPressed = false;
  gameLoop();
}

function restartGame() {
  document.getElementById('gameOverScreen').style.display = 'none';
  startGame();
}
</script>
</body>
</html>
